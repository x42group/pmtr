<!DOCTYPE html>
<html>
<head>
  <meta http-equiv='content-type' value='text/html;charset=utf8'>
  <meta name='generator' value='Ronn/v0.7.3 (http://github.com/rtomayko/ronn/tree/0.7.3)'>
  <title>pmtr(8) - Simple supervisory daemon for linux services</title>
  <style type='text/css' media='all'>
  /* style: man */
  body#manpage {margin:0}
  .mp {max-width:100ex;padding:0 9ex 1ex 4ex}
  .mp p,.mp pre,.mp ul,.mp ol,.mp dl {margin:0 0 20px 0}
  .mp h2 {margin:10px 0 0 0}
  .mp > p,.mp > pre,.mp > ul,.mp > ol,.mp > dl {margin-left:8ex}
  .mp h3 {margin:0 0 0 4ex}
  .mp dt {margin:0;clear:left}
  .mp dt.flush {float:left;width:8ex}
  .mp dd {margin:0 0 0 9ex}
  .mp h1,.mp h2,.mp h3,.mp h4 {clear:left}
  .mp pre {margin-bottom:20px}
  .mp pre+h2,.mp pre+h3 {margin-top:22px}
  .mp h2+pre,.mp h3+pre {margin-top:5px}
  .mp img {display:block;margin:auto}
  .mp h1.man-title {display:none}
  .mp,.mp code,.mp pre,.mp tt,.mp kbd,.mp samp,.mp h3,.mp h4 {font-family:monospace;font-size:14px;line-height:1.42857142857143}
  .mp h2 {font-size:16px;line-height:1.25}
  .mp h1 {font-size:20px;line-height:2}
  .mp {text-align:justify;background:#fff}
  .mp,.mp code,.mp pre,.mp pre code,.mp tt,.mp kbd,.mp samp {color:#131211}
  .mp h1,.mp h2,.mp h3,.mp h4 {color:#030201}
  .mp u {text-decoration:underline}
  .mp code,.mp strong,.mp b {font-weight:bold;color:#131211}
  .mp em,.mp var {font-style:italic;color:#232221;text-decoration:none}
  .mp a,.mp a:link,.mp a:hover,.mp a code,.mp a pre,.mp a tt,.mp a kbd,.mp a samp {color:#0000ff}
  .mp b.man-ref {font-weight:normal;color:#434241}
  .mp pre {padding:0 4ex}
  .mp pre code {font-weight:normal;color:#434241}
  .mp h2+pre,h3+pre {padding-left:0}
  ol.man-decor,ol.man-decor li {margin:3px 0 10px 0;padding:0;float:left;width:33%;list-style-type:none;text-transform:uppercase;color:#999;letter-spacing:1px}
  ol.man-decor {width:100%}
  ol.man-decor li.tl {text-align:left}
  ol.man-decor li.tc {text-align:center;letter-spacing:4px}
  ol.man-decor li.tr {text-align:right;float:right}
  </style>
</head>
<!--
  The following styles are deprecated and will be removed at some point:
  div#man, div#man ol.man, div#man ol.head, div#man ol.man.

  The .man-page, .man-decor, .man-head, .man-foot, .man-title, and
  .man-navigation should be used instead.
-->
<body id='manpage'>
  <div class='mp' id='man'>

  <div class='man-navigation' style='display:none'>
    <a href="#NAME">NAME</a>
    <a href="#SYNOPSIS">SYNOPSIS</a>
    <a href="#DESCRIPTION">DESCRIPTION</a>
    <a href="#USAGE">USAGE</a>
    <a href="#OPTIONS">OPTIONS</a>
    <a href="#CONFIGURATION">CONFIGURATION</a>
    <a href="#PMTR-CONF-OPTIONS">PMTR.CONF OPTIONS</a>
    <a href="#LOGGING">LOGGING</a>
    <a href="#JOB-EXITS">JOB EXITS</a>
    <a href="#IN-A-CONTAINER">IN A CONTAINER</a>
    <a href="#UDP-CONTROL">UDP CONTROL</a>
    <a href="#EXAMPLES">EXAMPLES</a>
    <a href="#AUTHOR">AUTHOR</a>
  </div>

  <ol class='man-decor man-head man head'>
    <li class='tl'>pmtr(8)</li>
    <li class='tc'></li>
    <li class='tr'>pmtr(8)</li>
  </ol>

  <h2 id="NAME">NAME</h2>
<p class="man-name">
  <code>pmtr</code> - <span class="man-whatis">Simple supervisory daemon for linux services</span>
</p>

<h2 id="SYNOPSIS">SYNOPSIS</h2>

<p><a class="man-ref" href="pmtr.8.html">pmtr<span class="s">(8)</span></a> is a simple supervisory daemon for linux services. <a class="man-ref" href="pmtr.8.html">pmtr<span class="s">(8)</span></a> runs under systemd as well
as other init mechanisms like sysvinit, etc.  It can also run as process 1 inside a container.<br />
When installing on many flavors or Linux, it can detect the nost init and set itself up to
start at boot appropriately.</p>

<h2 id="DESCRIPTION">DESCRIPTION</h2>

<p>Pmtr has a few goals:</p>

<ul>
<li>to have one configuration file listing all processes to run</li>
<li>to exist under (not to replace) the host init system</li>
<li>to run under various host init systems</li>
<li>to consume few resource</li>
<li>to have few features</li>
</ul>


<p>It is especially useful in container (Docker, etc.) contexts to manage servers and processes.<br />
Unlike other systems (systemd, supervisord), pmtr is very easy to configure and monitor.<br />
While easy to configure, it supports many useful features such as control via an optional
UDP socket, allows for automatic restart of processes on a time interval or when exited,
stderr/stdout log to arbitrary files, set nice priority.  pmtr has been deployed on a wide
variety of Linux platforms for many uses, including Arch, Alpine, Debian, Ubuntu,
CentOS/RHEL, Amazon Linux, Raspberry Pi, Beaglebone, and Yocto.</p>

<p>It is written in C, supports Linux only, and is MIT licensed.</p>

<h2 id="USAGE">USAGE</h2>

<p>When pmtr is started, it starts all the jobs in <code>pmtr.conf</code>, likewise, pmtr
terminates them when it is stopped.</p>

<p>In practice the host init system - often systemd - manages all the standard
OS services. <a class="man-ref" href="pmtr.8.html">pmtr<span class="s">(8)</span></a> is generally used to run  local software - the parts that
make up an appliance, often comprising a dozen or two dozen jobs that function together.</p>

<p>There are many options to use inside the job, listed later below.</p>

<p>Processes that run under pmtr should stay in the foreground, exit on SIGTERM or
SIGKILL, and clean up after their own sub-processes when exiting.</p>

<p>If a job exits, pmtr restarts it. If it exits too quickly - less than 10 seconds
after it started - pmtr delays its restart 10 seconds to avoid rapid cycling.</p>

<p>If the operator edits <code>pmtr.conf</code> and saves the file, the changes take effect
immediately. There is no need to tell pmtr to reload its configuration file.</p>

<h2 id="OPTIONS">OPTIONS</h2>

<p>The host init system normally runs pmtr at system boot. You can instead run
pmtr manually. Or, it can be the init process inside a container. In these
use cases, the following command line options may be useful.</p>

<dl>
<dt><code>-h</code>, <code>--help</code> </dt><dd><p>Displays the help screen.</p></dd>
<dt class="flush"><code>-F</code> </dt><dd><p>stay in foreground (enabled by default when PID 1)</p></dd>
<dt class="flush"><code>-I</code> </dt><dd><p>echo syslog to stderr (enabled by default)</p></dd>
<dt><code>-c &lt;file></code> </dt><dd><p>specify configuration file</p></dd>
<dt class="flush"><code>-t</code> </dt><dd><p>test syntax (parse config file and exit)</p></dd>
<dt class="flush"><code>-v</code> </dt><dd><p>verbose logging (repeatable), -vv shows parsing</p></dd>
<dt><code>-p &lt;file></code> </dt><dd><p>make pidfile</p></dd>
</dl>


<h2 id="CONFIGURATION">CONFIGURATION</h2>

<p>The configuration file <code>/etc/pmtr.conf</code> drives pmtr.</p>

<p>The config file can be changed using a command line option (<code>-c</code>) when running
pmtr from the command line.</p>

<p>As shown previously it consists of zero or more job definitions. A job is just
a process definition. It looks like:</p>

<pre><code>  job {
    name bitcoin-daemon
    dir /home/bitcoin
    cmd /usr/local/bin/bitcoind
    user bitcoin
    env HOME=/home/bitcoin
  }
</code></pre>

<p>A job must have a <code>name</code> (used for logging only) and a <code>cmd</code>. Everything else
in the curly braces optional.</p>

<ul>
<li>Order does not matter.</li>
<li>Indentation is optional.</li>
<li>Blank lines are ok.</li>
<li>Comments start with <code>#</code>.</li>
</ul>


<h2 id="PMTR-CONF-OPTIONS">PMTR.CONF OPTIONS</h2>

<p>The full list of options that may appear inside a job are listed here.</p>

<ul>
<li>name : descriptive job name used for logging - must be unique</li>
<li>cmd : executable (fully-qualified) and any arguments</li>
<li>dir : working directory (fully qualified) to run the process in</li>
<li>out : send stdout to this file</li>
<li>err : send stderr to this file</li>
<li>in : take stdin from this file</li>
<li>env : environment variable to set (repeatable)</li>
<li>user : unix username under whose id to run the process</li>
<li>nice : unix priority between -19 (highest) and 20 (lowest)</li>
<li>cpu : CPU affinity as hex mask (0xABCD) or number/ranges (0,2-4)</li>
<li>ulimit : process ulimits</li>
<li>bounce :   | a time interval to restart the process</li>
<li>depends : files to watch, any changes induce the job to restart</li>
<li>disable : disable the job</li>
<li>wait : (special) wait for the job to finish before going on</li>
<li>once : (special) do not restart the job</li>
</ul>


<p>More details on each option follows.</p>

<h3 id="cmd">cmd</h3>

<ul>
<li>Specifies the <em>absolute path</em> to the executable (there is no $PATH searching!)</li>
<li>It may have arguments after the executable (e.g. <code>cmd /usr/bin/python rest.py</code>)</li>
<li>Use double-quotes to make one argument from the quoted string.</li>
<li>No shell expansion: no wildcards, backticks, variables, etc.</li>
</ul>


<p>If you need shell features in your command, wrap it with a shell script. You
can also use a quoted string as a shell script like this:</p>

<pre><code>  job {
    name api
    cmd /bin/bash -c "ifconfig eth1 up; sleep 5; exec /api/rest.py"
  }
</code></pre>

<h3 id="env">env</h3>

<ul>
<li>Use to push an environment variable into a job, e.g. <code>env DEBUG=1</code>.</li>
<li>Use repeatedly on separate lines to set multiple environment variables.</li>
</ul>


<h3 id="disable">disable</h3>

<ul>
<li>Use <code>disable</code> on a line by itself to make the job disabled.</li>
<li>This is sometimes quicker than commenting out the whole job.</li>
</ul>


<h3 id="out-err-in">out, err, in</h3>

<ul>
<li>Use <code>out</code> and <code>err</code> to send stdout or stderr to a file.</li>
<li>stdout and stderr go to syslog by default.</li>
<li>stdin defaults to <code>/dev/null</code>; use <code>in</code> to override</li>
</ul>


<h3 id="nice">nice</h3>

<ul>
<li>This changes the process priority</li>
<li>Takes a number in the range -19 (highest priority) to 20 (lowest)</li>
</ul>


<h3 id="cpu">cpu</h3>

<ul>
<li>This sets the CPU affinity- the list of CPU's the task can run on</li>
<li>Takes a CPU number (e.g. 0) or range (e.g. 2-4) or a mix (e.g. 0,2-4)</li>
<li>Alternatively, can take a 0x-prefixed hex mask (e.g. 0x8f)</li>
<li>Any CPUs in the set that are physically absent are ignored</li>
</ul>


<h3 id="user">user</h3>

<ul>
<li>Specifies the unix username to run the process as.</li>
<li>That user's uid/gid becomes those of the process.</li>
<li>Defaults to root (when pmtr is running as root)</li>
</ul>


<h3 id="depends">depends</h3>

<ul>
<li>Specifies a block of one or more files that the job depends on.</li>
<li>pmtr watches the dependencies for changes to their content.</li>
<li>Pmtr restarts the job if a change is detected.</li>
</ul>


<pre><code>  job {
    name bitcoin-daemon
    dir /home/bitcoin
    cmd /usr/bin/bitcoind
    user bitcoin
    env HOME=/home/bitcoin
    depends {
      /home/bitcoin/.bitcoin/bitcoin.conf
    }
  }
</code></pre>

<h3 id="bounce-every">bounce every</h3>

<ul>
<li>Use <code>bounce every</code> to restart a job on a periodic interval.</li>
<li>It takes a number and unit [smhd] e.g. <code>bounce every 1d</code>.</li>
<li>Units [smhd] are seconds, minutes, hours or days.</li>
<li>The exact timing of the restart is approximate.</li>
</ul>


<h3 id="ulimit">ulimit</h3>

<ul>
<li>Use to modify the system resource limits for the job.</li>
<li>Takes a flag and value, e.g., <code>ulimit -n 30</code>.</li>
<li>Values are numeric or the keyword <code>infinity</code>.</li>
</ul>


<p>To see the current limits on a process by its PID:</p>

<pre><code>cat /proc/&lt;pid>/limits
</code></pre>

<p>Pmtr sets both the "hard" and "soft" limit to the same value.
Any error in setting the limit is logged to syslog.</p>

<p>See <code>man prlimit</code> for technical descriptions of each limit.
In the <code>bash</code> shell, <code>ulimit -a</code> and <code>help ulimit</code> display the
limits and a list of flags and descriptions respectively.</p>

<p>The units are discussed in the <span class="man-ref">prlimit<span class="s">(2)</span></span> man page.</p>

<h3 id="wait-once">wait/once</h3>

<ul>
<li>Used for setup jobs that need not be restarted.</li>
<li><code>wait</code> pauses the startup of subsequent jobs.</li>
<li><code>once</code> tells pmtr not to restart this job.</li>
</ul>


<pre><code>    job {
      name initial-setup
      cmd /bin/mkdir /dev/shm/go
      wait
      once
    }
</code></pre>

<h2 id="LOGGING">LOGGING</h2>

<p>Logging from pmtr goes to syslog. Typically these logs go to <code>/var/log/syslog</code> or
<code>/var/log/messages</code>.  Check the syslog after any change to <code>pmtr.conf</code>.  Errors in
parsing <code>pmtr.conf</code> are logged there, as well as job start or exit events.  On
systemd-based hosts, you can also use <code>journalctl -u pmtr</code> to see pmtr logs.</p>

<h2 id="JOB-EXITS">JOB EXITS</h2>

<p>If a job terminates by itself, when pmtr did not signal it to exit, (and the
job does not have the <code>once</code> option), pmtr restarts it. However, if it exited
within 10 seconds of when it started, pmtr waits 10 seconds to restart it. The
10-second wait prevents rapid process cycling.  Also, a job that's waiting for
something (like a network resource to come up) can be designed to exit instead
of retry, relying on pmtr to restart it periodically to try again.</p>

<p>Pmtr terminates a job when it is deleted, disabled, or altered in <code>pmtr.conf</code>,
or is being bounced due to the <code>bounce every</code> option; or because pmtr itself is
being shut down.  To terminate a job, pmtr sends SIGTERM to it, then SIGKILL
shortly afterward, if it's still running.</p>

<h2 id="IN-A-CONTAINER">IN A CONTAINER</h2>

<p>When pmtr is the init entrypoint (process 1) in a container, it stays in the
foreground by default. An example invocation command is shown.</p>

<p>  # container entrypoint
  /usr/bin/pmtr -IFc /path/to/pmtr.conf</p>

<h2 id="UDP-CONTROL">UDP CONTROL</h2>

<p>NOTE: This feature is disabled by default.</p>

<p>These options may appear in <code>pmtr.conf</code> at the global scope.</p>

<pre><code>  report to udp://127.0.0.1:9999
  listen on udp://0.0.0.0:10000
</code></pre>

<p>The <code>report to</code> option designates a remote address and port to which pmtr
should send a a UDP packet every ten seconds.  The packet payload lists the job
names, enabled or disabled status, and elapsed runtimes in simple text. If the
<code>report to</code> address falls in the multicast UDP range (e.g. 239.0.0.1, etc), the
specification may include a trailing interface, e.g., <code>report to
udp://239.0.0.1:9999@eth2</code> to designate the interface from which the multicast
UDP datagrams should egress.</p>

<p>The <code>listen on</code> option allows jobs to be remotely enabled or disabled. It
specifies a UDP address and port that pmtr should listen on for datagrams of
form <code>enable abc</code> or <code>disable abc</code>, where 'abc' is a job name.  The address
0.0.0.0 can be used as a shortcut to denote "any address" on this system.  The
effect is temporary; the settings in pmtr.conf resume precedence when it's
edited or pmtr is restarted.</p>

<p>These options are considered experimental and may be replaced or removed.</p>

<h2 id="EXAMPLES">EXAMPLES</h2>

<p>Here is an example pmtr.conf:</p>

<pre><code>    job {
    name tunnel
    cmd /usr/bin/ssh -i key -TNL 5901:127.0.0.1:5901 192.168.0.1
    }

    job {
    name bitcoin-daemon
    dir /home/bitcoin
    cmd /usr/local/bin/bitcoind
    user bitcoin
    env HOME=/home/bitcoin
    cpu 0-8
    }

    job {
    name capture
    dir /data
    cmd /usr/sbin/tcpdump -i eth0 -s 0 -G 10 -w %Y%m%d%H%M%S.pcap
</code></pre>

<h2 id="AUTHOR">AUTHOR</h2>

<ul>
<li>Software: Troy Hanson <a href="&#x6d;&#97;&#105;&#108;&#116;&#111;&#x3a;&#116;&#100;&#x68;&#x40;&#x74;&#107;&#x68;&#97;&#x6e;&#115;&#x6f;&#x6e;&#x2e;&#110;&#x65;&#x74;" data-bare-link="true">&#116;&#100;&#104;&#x40;&#116;&#x6b;&#x68;&#x61;&#110;&#x73;&#x6f;&#110;&#x2e;&#x6e;&#101;&#x74;</a></li>
<li>Package Mantainer: Michael Moore <a href="&#109;&#x61;&#105;&#x6c;&#x74;&#x6f;&#x3a;&#109;&#64;&#x78;&#52;&#x32;&#x2e;&#x67;&#x72;&#x6f;&#x75;&#x70;" data-bare-link="true">&#109;&#64;&#120;&#x34;&#x32;&#x2e;&#103;&#114;&#x6f;&#x75;&#x70;</a></li>
</ul>



  <ol class='man-decor man-foot man foot'>
    <li class='tl'></li>
    <li class='tc'>January 2020</li>
    <li class='tr'>pmtr(8)</li>
  </ol>

  </div>
</body>
</html>
